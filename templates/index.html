<!DOCTYPE html>
<html lang="en" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/morphdom@2.7.0/dist/morphdom-umd.js"></script>
    <title>Mastercam PDM</title>
    <link rel="stylesheet" href="/static/css/tailwind.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      .status.warning {
        background-color: #f59e0b; /* This is Tailwind's amber-500 color */
        color: white;
      }
    </style>
  </head>

  <body class="app-bg app-text font-sans antialiased">
    <div class="flex flex-col h-screen">
      <header class="flex-shrink-0 header-bg shadow-md z-30">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center space-x-6">
              <div class="flex items-center space-x-3">
                <i class="fa-solid fa-database text-2xl"></i>
                <h1 class="text-xl font-bold">Mastercam PDM</h1>
              </div>
              <div
                class="hidden md:flex items-center space-x-2 border-l border-border-color pl-6"
              >
                <div
                  id="connectionStatus"
                  class="w-3 h-3 rounded-full bg-green-500"
                ></div>
                <span id="connectionText" class="text-sm font-medium"
                  >Connected</span
                >
              </div>
              <div class="hidden lg:flex items-center space-x-2">
                <i class="fa-solid fa-user"></i>
                <span class="text-sm"
                  >User:
                  <span id="currentUser" class="font-semibold"
                    >demo_user</span
                  ></span
                >
              </div>
            </div>

            <div class="flex items-center space-x-2">
              <div class="relative hidden sm:block">
                <i
                  class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-app-text opacity-70 pointer-events-none"
                ></i>
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search..."
                  class="w-48 lg:w-64 pl-9 pr-10 py-2 text-sm rounded-md border-border-color bg-panel-bg focus:ring-accent focus:border-accent"
                />
                <button
                  id="clearSearchBtn"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-app-text opacity-70 hover:opacity-100 hidden"
                >
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>

              <button onclick="showNewFileDialog()" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i
                ><span class="hidden lg:inline">New File</span>
              </button>
              <button id="dashboardBtn" class="btn btn-secondary">
                <i class="fa-solid fa-chart-line"></i
                ><span class="hidden lg:inline">Dashboard</span>
              </button>

              <div
                id="adminActionsContainer"
                class="flex items-center space-x-2"
              >
                <button id="globalAdminToggle" class="btn btn-secondary hidden">
                  <i class="fa-solid fa-user-shield"></i
                  ><span class="hidden lg:inline">Admin</span>
                </button>
                <button id="sendMessageBtn" class="btn btn-secondary hidden">
                  <i class="fa-solid fa-envelope"></i
                  ><span class="hidden lg:inline">Message</span>
                </button>
              </div>

              <div class="h-6 w-px bg-border-color mx-2"></div>

              <button
                onclick="manualRefresh()"
                class="btn btn-secondary !px-3"
                title="Manual Refresh"
              >
                <i class="fa-solid fa-arrows-rotate"></i>
              </button>
              <button
                id="collapseAllBtn"
                class="btn btn-secondary !px-3"
                title="Collapse All"
              >
                <i class="fa-solid fa-compress"></i>
              </button>

              <div class="h-6 w-px bg-border-color mx-2"></div>

              <button
                onclick="toggleDarkMode()"
                class="btn btn-secondary !px-3"
                title="Toggle Dark Mode"
              >
                <i class="fa-solid fa-moon"></i>
              </button>
              <button
                onclick="toggleConfigPanel()"
                class="btn btn-secondary !px-3"
                title="Settings"
              >
                <i class="fa-solid fa-gear"></i>
              </button>
            </div>
          </div>
        </div>
      </header>

      <main
        class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8 overflow-y-auto"
      >
        <div id="fileList" class="space-y-4">
          <div class="flex justify-center items-center py-24 text-gray-500">
            <div
              class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-amber-500"
            ></div>
          </div>
        </div>
      </main>
    </div>

    <div
      id="configPanel"
      class="fixed inset-y-0 right-0 w-full max-w-md transform translate-x-full transition-transform duration-300 panel-bg shadow-lg p-6 z-50 overflow-y-auto"
    >
      <div
        class="flex justify-between items-center pb-4 mb-4 border-b border-gray-200 dark:border-gray-700"
      >
        <h3 class="text-2xl font-semibold text-gray-900 dark:text-accent">
          Settings
        </h3>
        <button
          class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white"
          onclick="toggleConfigPanel()"
        >
          <i class="fa-solid fa-xmark text-2xl"></i>
        </button>
      </div>
      <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
        <h4 class="text-lg font-semibold mb-3">Accent Color</h4>
      </div>
      <form id="configForm" class="space-y-4">
        <div>
          <label for="gitlabUrl" class="block text-sm font-medium"
            >GitLab URL</label
          ><input type="url" id="gitlabUrl" required class="input-field" />
        </div>
        <div>
          <label for="projectId" class="block text-sm font-medium"
            >Project ID</label
          ><input type="text" id="projectId" required class="input-field" />
        </div>
        <div>
          <label for="username" class="block text-sm font-medium"
            >Username</label
          ><input
            type="text"
            id="username"
            autocomplete="username"
            required
            class="input-field"
          />
        </div>
        <div>
          <label for="token" class="block text-sm font-medium"
            >Access Token</label
          ><input
            type="password"
            id="token"
            autocomplete="current-password"
            class="input-field"
          />
        </div>
        <button
          type="submit"
          class="btn btn-primary w-full justify-center !py-3"
        >
          <i class="fa-solid fa-floppy-disk"></i><span>Save Configuration</span>
        </button>
      </form>
      <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
        <h4 class="text-lg font-semibold mb-2">Current Status</h4>
        <p class="text-sm">
          <strong>Status:</strong>
          <span id="configStatusText" class="font-medium text-accent"
            >Not configured</span
          >
        </p>
        <p class="text-sm mt-1">
          <strong>Repository Path:</strong>
          <span id="configRepoText" class="font-medium text-accent"
            >Not available</span
          >
        </p>
      </div>
    </div>

    <div
      id="checkinModal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden"
    >
      <div class="panel-bg rounded-xl shadow-lg p-6 w-full max-w-lg">
        <form id="checkinForm">
          <h3
            id="checkinModalTitle"
            class="text-xl font-semibold text-gray-900 dark:text-accent mb-4"
          >
            Check In File
          </h3>
          <div class="mb-4">
            <label for="commitMessage" class="block text-sm font-medium mb-1"
              >Describe your changes:</label
            ><textarea
              id="commitMessage"
              name="commitMessage"
              rows="3"
              required
              class="input-field"
            ></textarea>
          </div>
          <div class="mb-4">
            <label
              for="checkinFileUpload"
              class="block text-sm font-medium mb-1"
              >Upload the updated file:</label
            ><input
              id="checkinFileUpload"
              name="file"
              type="file"
              required
              class="w-full text-sm text-gray-500 dark:text-gray-400"
            />
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium mb-2"
              >Revision Increment:</label
            >
            <div class="space-y-2">
              <label class="flex items-center space-x-2"
                ><input
                  type="radio"
                  name="rev_type"
                  value="minor"
                  checked
                  class="text-accent focus:ring-accent"
                /><span>Minor (e.g., 1.1 -> 1.2)</span></label
              >
              <div class="flex items-center space-x-2">
                <label class="flex items-center space-x-2"
                  ><input
                    type="radio"
                    name="rev_type"
                    value="major"
                    class="text-accent focus:ring-accent"
                  /><span>Major:</span></label
                >
                <input
                  type="text"
                  id="newMajorRevInput"
                  placeholder="e.g., 5"
                  pattern="[0-9]*"
                  disabled
                  class="w-24 p-1 border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                />
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" id="cancelCheckin" class="btn btn-secondary">
              Cancel</button
            ><button type="submit" class="btn btn-info">Submit Check-in</button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="newUploadModal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden"
    >
      <div class="panel-bg rounded-xl shadow-lg p-6 w-full max-w-lg">
        <form id="newUploadForm" class="space-y-4" novalidate>
          <h3 class="text-xl font-semibold mb-2">Add New File or Link</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <input
                type="radio"
                id="uploadTypeFile"
                name="uploadType"
                value="file"
                class="hidden peer"
                checked
              /><label
                for="uploadTypeFile"
                class="block p-3 text-center rounded-lg border-2 border-gray-300 dark:border-gray-600 cursor-pointer peer-checked:border-accent peer-checked:text-accent dark:peer-checked:border-accent dark:peer-checked:text-accent hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                ><i class="fa-solid fa-file-arrow-up text-xl mb-1"></i>
                <div class="font-semibold">Upload File</div></label
              >
            </div>
            <div>
              <input
                type="radio"
                id="uploadTypeLink"
                name="uploadType"
                value="link"
                class="hidden peer"
              /><label
                for="uploadTypeLink"
                class="block p-3 text-center rounded-lg border-2 border-gray-300 dark:border-gray-600 cursor-pointer peer-checked:border-accent peer-checked:text-accent dark:peer-checked:border-accent dark:peer-checked:text-accent hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                ><i class="fa-solid fa-link text-xl mb-1"></i>
                <div class="font-semibold">Create Link</div></label
              >
            </div>
          </div>
          <div id="fileUploadContainer">
            <label for="newFileUpload" class="block text-sm font-medium"
              >Mastercam File <span class="text-red-500">*</span></label
            ><input
              type="file"
              id="newFileUpload"
              name="file"
              accept=".mcam,.vnc"
              class="mt-1 block w-full text-sm text-gray-500 dark:text-gray-400"
            />
          </div>
          <div id="linkCreateContainer" class="hidden space-y-4">
            <div>
              <label for="newLinkFilename" class="block text-sm font-medium"
                >New Filename for Link
                <span class="text-red-500">*</span></label
              ><input
                type="text"
                id="newLinkFilename"
                name="new_link_filename"
                placeholder="e.g., 1234567_M70.mcam"
                class="input-field"
              />
            </div>
            <div>
              <label for="linkToMaster" class="block text-sm font-medium"
                >Link to Master File <span class="text-red-500">*</span></label
              ><input
                type="text"
                id="linkToMaster"
                name="link_to_master"
                list="masterFileList"
                placeholder="Start typing to see available files..."
                class="input-field"
              />
            </div>
          </div>
          <div>
            <label for="newFileDescription" class="block text-sm font-medium"
              >Description <span class="text-red-500">*</span></label
            ><input
              type="text"
              id="newFileDescription"
              name="description"
              placeholder="Part name per title block"
              required
              class="input-field"
            />
          </div>
          <div>
            <label for="newFileRev" class="block text-sm font-medium"
              >Initial Revision <span class="text-red-500">*</span></label
            ><input
              type="text"
              id="newFileRev"
              name="rev"
              placeholder="1.0"
              required
              pattern="^\d+\.\d+$"
              class="input-field"
            />
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              id="cancelNewUpload"
              class="btn btn-secondary"
            >
              Cancel</button
            ><button type="submit" class="btn btn-primary">
              <span id="submitBtnText">Create</span
              ><i
                id="submitSpinner"
                class="fa-solid fa-spinner fa-spin ml-2 hidden"
              ></i>
            </button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="sendMessageModal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden"
    >
      <div class="panel-bg rounded-xl shadow-lg p-6 w-full max-w-lg">
        <form id="sendMessageForm">
          <h3 class="text-xl font-semibold mb-4">Send Message</h3>
          <div class="mb-4">
            <label
              for="recipientUserSelect"
              class="block text-sm font-medium mb-1"
              >Recipient:</label
            ><select
              id="recipientUserSelect"
              class="input-field w-full"
            ></select>
          </div>
          <div class="mb-6">
            <label for="messageText" class="block text-sm font-medium mb-1"
              >Message:</label
            ><textarea
              id="messageText"
              rows="4"
              class="input-field w-full"
            ></textarea>
          </div>
          <div class="flex justify-end space-x-4">
            <button
              type="button"
              id="cancelSendMessage"
              class="btn btn-secondary"
            >
              Cancel</button
            ><button type="submit" class="btn btn-primary">Send</button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="viewMessagesModal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden"
    >
      <div class="panel-bg rounded-xl shadow-lg p-6 w-full max-w-lg">
        <h3 class="text-xl font-semibold mb-4">Your Messages</h3>
        <div
          id="messageListContainer"
          class="space-y-4 max-h-96 overflow-y-auto"
        ></div>
        <div class="flex justify-end mt-4">
          <button
            onclick="document.getElementById('viewMessagesModal').classList.add('hidden')"
            class="btn btn-secondary"
          >
            Close
          </button>
        </div>
      </div>
    </div>
    <div
      id="dashboardModal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden"
    >
      <div
        class="panel-bg rounded-xl shadow-lg w-full max-w-4xl flex flex-col max-h-[90vh]"
      >
        <div
          class="flex-shrink-0 flex justify-between items-center p-6 pb-4 border-b border-gray-200 dark:border-gray-700"
        >
          <h3 class="text-xl font-semibold text-gray-900 dark:text-accent">
            <i class="fa-solid fa-chart-line mr-2"></i>Activity Dashboard
          </h3>
          <button
            id="closeDashboardBtn"
            class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white"
          >
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>
        <div
          id="dashboardContent"
          class="flex-grow min-h-0 p-6 flex flex-col md:flex-row md:space-x-6"
        >
          <div
            id="activeCheckoutsContainer"
            class="md:w-1/2 flex flex-col"
          ></div>
          <div
            id="activityFeedContainer"
            class="md:w-1/2 flex flex-col mt-6 md:mt-0 md:border-l md:pl-6 border-gray-200 dark:border-gray-700"
          ></div>
        </div>
      </div>
    </div>

    <datalist id="masterFileList"></datalist>
    <div
      id="notification-container"
      class="fixed bottom-4 right-4 z-[1000] w-full max-w-sm space-y-3"
    ></div>

    <script src="/static/js/script.js"></script>
  </body>
</html>
